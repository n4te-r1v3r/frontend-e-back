<div class="chamados-wrapper" role="main">
  <!-- Header da tela de Chamados -->
  <header class="chamados-header">
    <div class="header-content">
      <div class="page-info">
        <h1 class="page-title">Chamados</h1>
        <p class="page-subtitle">Gerenciamento de tickets e solicitações</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" 
                aria-label="Filtrar chamados"
                tabindex="0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14,12V19.88C14.04,20.18 13.94,20.5 13.71,20.71C13.32,21.1 12.69,21.1 12.3,20.71L10.29,18.7C10.06,18.47 9.96,18.16 10,17.87V12H9.97L4.21,4.62C3.87,4.19 3.95,3.56 4.38,3.22C4.57,3.08 4.78,3 5,3V3H19V3C19.22,3 19.43,3.08 19.62,3.22C20.05,3.56 20.13,4.19 19.79,4.62L14.03,12H14Z"/>
          </svg>
          Filtros
        </button>
        <button class="btn btn-primary" 
                aria-label="Criar novo chamado"
                (click)="openCreateModal()" 
                tabindex="0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
          </svg>
          Novo Chamado
        </button>
      </div>
    </div>
  </header>

  <!-- Conteúdo Principal -->
  <div class="chamados-content">
    <!-- Lista de Chamados -->
    <section class="tickets-section" aria-labelledby="tickets-title">
      <div class="section-card">
        <header class="card-header">
          <div class="header-left">
            <h2 id="tickets-title" class="card-title">Lista de Chamados</h2>
            <p class="card-subtitle" *ngIf="tickets$ | async as tickets">
              {{ tickets.length }} chamados encontrados
            </p>
          </div>
          <div class="header-actions">
            <div class="view-options">
              <button class="view-toggle" 
                      [class.active]="viewMode === 'list'"
                      (click)="setViewMode('list')"
                      aria-label="Visualização em lista"
                      tabindex="0">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3,5H21V7H3V5M3,11H21V13H3V11M3,17H21V19H3V17Z"/>
                </svg>
              </button>
              <button class="view-toggle" 
                      [class.active]="viewMode === 'grid'"
                      (click)="setViewMode('grid')"
                      aria-label="Visualização em grade"
                      tabindex="0">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3,11H11V3H3M3,21H11V13H3M13,21H21V13H13M13,3V11H21V3"/>
                </svg>
              </button>
            </div>
          </div>
        </header>
        
        <div class="tickets-container" [class]="'view-' + viewMode">
          <div class="tickets-list" *ngIf="tickets$ | async as ticketsList; else loadingTickets">
            <ng-container *ngIf="ticketsList.length > 0; else noTickets">
              <article class="ticket-card" 
                       *ngFor="let ticket of ticketsList; trackBy: trackTicket"
                       tabindex="0"
                       [attr.aria-label]="getTicketAriaLabel(ticket)"
                       (click)="selectTicket(ticket)"
                       (keydown.enter)="selectTicket(ticket)"
                       (keydown.space)="selectTicket(ticket)"
                       [class.selected]="selectedTicket?.id === ticket.id"
                       role="button">
                
                <!-- Indicador de prioridade -->
                <div class="ticket-priority" 
                     [class]="'priority-' + ticket.priority.toLowerCase()"
                     [attr.aria-label]="'Prioridade: ' + ticket.priority">
                </div>
                
                <!-- Conteúdo do ticket -->
                <div class="ticket-content">
                  <div class="ticket-header">
                    <h3 class="ticket-title">{{ ticket.title }}</h3>
                    <span class="ticket-time">{{ getTimeAgo(ticket.createdAt) }}</span>
                  </div>
                  
                  <p class="ticket-description" *ngIf="viewMode === 'list'">
                    {{ ticket.description }}
                  </p>
                  
                  <div class="ticket-meta">
                    <div class="meta-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4,1H20A1,1 0 0,1 21,2V6A1,1 0 0,1 20,7H4A1,1 0 0,1 3,6V2A1,1 0 0,1 4,1Z"/>
                      </svg>
                      <span>{{ ticket.assetName }}</span>
                    </div>
                    <div class="meta-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                      </svg>
                      <span>{{ ticket.authorName }}</span>
                    </div>
                  </div>
                </div>
                
                <!-- Status -->
                <div class="ticket-footer">
              <span class="status-badge" 
                        [class]="'status-' + (ticket.status ? ticket.status.toLowerCase().replace(' ', '-') : 'desconhecido')"
                        [attr.aria-label]="'Status: ' + (ticket.status || 'Desconhecido')">
                    <span class="status-indicator"></span>
                    {{ ticket.status }}
                  </span>
                  
                  <div class="ticket-actions">
                    <button class="action-btn" 
                            [attr.aria-label]="'Alterar status do chamado ' + ticket.title"
                            (click)="$event.stopPropagation(); toggleStatus(ticket)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
                      </svg>
                    </button>
                    <button class="action-btn" 
                            [attr.aria-label]="'Excluir chamado ' + ticket.title"
                            (click)="$event.stopPropagation(); deleteTicket(ticket)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </article>
            </ng-container>
          </div>
          
          <!-- Estado de carregamento -->
          <ng-template #loadingTickets>
            <div class="loading-state">
              <div class="loading-spinner"></div>
              <p>Carregando chamados...</p>
            </div>
          </ng-template>
          
          <!-- Estado vazio -->
          <ng-template #noTickets>
            <div class="empty-state" role="status">
              <div class="empty-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19,5V7H15V5H19M9,5V11H5V5H9M19,13V19H15V13H19M9,17V19H5V17H9M21,3H13V9H21V3M11,3H3V13H11V3M21,11H13V21H21V11M11,15H3V21H11V15Z"/>
                </svg>
              </div>
              <h3 class="empty-title">Nenhum chamado encontrado</h3>
              <p class="empty-description">
                Não há chamados cadastrados no momento. 
                Clique em "Novo Chamado" para criar um.
              </p>
              <button class="btn btn-primary" (click)="openCreateModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                </svg>
                Criar Primeiro Chamado
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </section>

    <!-- Detalhes do Chamado -->
    <aside class="details-section" aria-labelledby="details-title" *ngIf="selectedTicket as ticket">
      <div class="section-card">
        <header class="card-header">
          <div class="header-left">
            <h2 id="details-title" class="card-title">Detalhes do Chamado</h2>
            <p class="card-subtitle">{{ ticket.title }}</p>
          </div>
          <div class="header-actions">
            <button class="action-button" 
                    aria-label="Fechar detalhes"
                    (click)="closeDetails()" 
                    tabindex="0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
              </svg>
            </button>
          </div>
        </header>
        
        <div class="details-content">
          <!-- Informações principais -->
          <div class="info-section">
            <h3 class="section-title">Informações Gerais</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="status-badge" 
                      [class]="'status-' + (ticket.status ? ticket.status.toLowerCase().replace(' ', '-') : 'desconhecido')">
                  <span class="status-indicator"></span>
                  {{ ticket.status || 'Desconhecido' }}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Prioridade:</span>
                <span class="priority-badge" 
                      [class]="'priority-' + selectedTicket.priority.toLowerCase()">
                  {{ selectedTicket.priority }}
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Ativo:</span>
                <span class="info-value">{{ ticket.assetName }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Autor:</span>
                <span class="info-value">{{ ticket.authorName }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Criado em:</span>
                <span class="info-value">{{ ticket.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="info-item" *ngIf="ticket.resolvedAt">
                <span class="info-label">Resolvido em:</span>
                <span class="info-value">{{ ticket.resolvedAt | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </div>
          </div>
          
          <!-- Descrição -->
          <div class="description-section">
            <h3 class="section-title">Descrição</h3>
            <p class="description-text">{{ ticket.description }}</p>
          </div>
          
          <!-- Ações -->
          <div class="actions-section">
            <h3 class="section-title">Ações</h3>
            <div class="actions-grid">
              <button class="action-card" 
                      (click)="toggleStatus(ticket)"
                      [attr.aria-label]="ticket.status === 'Resolvido' ? 'Reabrir chamado' : 'Resolver chamado'">
                <div class="action-icon" 
                     [class.resolved]="ticket.status === 'Resolvido'">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
                  </svg>
                </div>
                <span class="action-title">
                  {{ ticket.status === 'Resolvido' ? 'Reabrir' : 'Resolver' }}
                </span>
              </button>
              
              <button class="action-card" 
                      aria-label="Excluir chamado"
                      (click)="deleteTicket(ticket)">
                <div class="action-icon delete">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                  </svg>
                </div>
                <span class="action-title">Excluir</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Placeholder quando nenhum chamado está selecionado -->
    <aside class="details-placeholder" *ngIf="!selectedTicket" role="complementary">
      <div class="placeholder-content">
        <div class="placeholder-icon">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,5V7H15V5H19M9,5V11H5V5H9M19,13V19H15V13H19M9,17V19H5V17H9M21,3H13V9H21V3M11,3H3V13H11V3M21,11H13V21H21V11M11,15H3V21H11V15Z"/>
          </svg>
        </div>
        <h3 class="placeholder-title">Selecione um Chamado</h3>
        <p class="placeholder-description">
          Escolha um chamado da lista para visualizar os detalhes completos.
        </p>
      </div>
    </aside>
  </div>

  <!-- Modal de Criação de Chamado -->
  <div class="modal-overlay" 
       *ngIf="showCreateModal" 
       @fadeIn
       (click)="closeCreateModal()"
       role="dialog"
       aria-modal="true"
       aria-labelledby="modal-title">
    <div class="modal-content" 
         @modalAnimation
         (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h2 id="modal-title" class="modal-title">Criar Novo Chamado</h2>
        <button class="modal-close" 
                (click)="closeCreateModal()"
                aria-label="Fechar modal">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
          </svg>
        </button>
      </header>
      
      <form class="modal-body" (ngSubmit)="saveNewTicket()">
        <div class="form-group">
          <label for="asset-select" class="form-label required">Ativo Relacionado</label>
          <select id="asset-select" 
                  name="assetId" 
                  [(ngModel)]="newTicketAssetId" 
                  class="form-select"
                  required>
            <option [ngValue]="undefined" disabled>Selecione um ativo...</option>
            <option *ngFor="let asset of assets$ | async; trackBy: trackAsset" 
                    [ngValue]="asset.id">
              {{ asset.name }} ({{ asset.serialNumber }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="title" class="form-label required">Título do Chamado</label>
          <input id="title" 
                 name="title" 
                 type="text" 
                 [(ngModel)]="newTicketTitle" 
                 class="form-input"
                 placeholder="Ex: Problema no monitor"
                 required>
        </div>

        <div class="form-group">
          <label for="description" class="form-label required">Descrição Detalhada</label>
          <textarea id="description" 
                    name="description" 
                    rows="4" 
                    [(ngModel)]="newTicketDescription" 
                    class="form-textarea"
                    placeholder="Descreva o problema em detalhes..."
                    required></textarea>
        </div>

        <div class="form-group">
          <label for="priority" class="form-label required">Prioridade</label>
          <select id="priority" 
                  name="priority" 
                  [(ngModel)]="newTicketPriority"
                  class="form-select">
            <option value="Baixa">Baixa</option>
            <option value="Média">Média</option>
            <option value="Alta">Alta</option>
            <option value="Urgente">Urgente</option>
          </select>
        </div>
      </form>
      
      <footer class="modal-footer">
        <button type="button" 
                class="btn btn-secondary" 
                (click)="closeCreateModal()">
          Cancelar
        </button>
        <button type="button" 
                class="btn btn-primary" 
                (click)="saveNewTicket()"
                [disabled]="!isFormValid()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
          </svg>
          Criar Chamado
        </button>
      </footer>
    </div>
  </div>

  <!-- Toast de notificações -->
  <div class="toast-container" aria-live="polite" aria-atomic="true">
    <div class="toast" 
         *ngIf="showToastFlag" 
         [class]="'toast-' + toastType"
         role="alert">
      <div class="toast-content">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" *ngIf="toastType === 'success'">
          <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/>
        </svg>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" *ngIf="toastType === 'error'">
          <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
        </svg>
        <span>{{ toastMessage }}</span>
      </div>
      <button class="toast-close" 
              (click)="closeToast()" 
              aria-label="Fechar notificação">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Screen Reader Only -->
<div class="sr-only" aria-live="polite" id="status-announcements"></div>